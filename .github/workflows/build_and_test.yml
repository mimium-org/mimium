name: build & test
on:
  push:
      branches:
      - master
      - dev
  pull_request:

jobs:
  prebuild:
    runs-on: ubuntu-latest
    outputs:
      lastmessage: ${{ steps.checkmessage.outputs.lastmessage }}
    steps: 
      - name : GITHUB CONTEXT
        env:
          GITHUB_CONTEXT: ${{ toJson(github) }}
        run: echo "$GITHUB_CONTEXT"
      - if: contains(github.event_name, 'pull_request')      
        uses: actions/checkout@v2
        with:
          ref: ${{ github.event.pull_request.head.sha }}
      - if: "!contains(github.event_name, 'pull_request')"  
        uses: actions/checkout@v2
      - id: checkmessage
        run: |
          git log --no-merges -1 --oneline
          echo "::set-output name=lastmessage::$(git log --no-merges -1 --oneline)"

  build:
    needs: prebuild
    if: "!contains( needs.prebuild.outputs.lastmessage , '[ci skip]')"
    runs-on: ${{ matrix.os }}
    timeout-minutes: 120
    strategy:
      fail-fast: false
      matrix:
        os:
          # - ubuntu-18.04
          - ubuntu-20.04
          - macos-latest
          - windows-latest
        config:
          - Release
        include:
            # - os: ubuntu-18.04
            #   cxx: /usr/bin/g++-9
            - os: ubuntu-20.04
              cxx: /usr/bin/g++-9
              shell: bash
            - os: macos-latest
              cxx: /usr/bin/clang++
              shell: bash
            - os: windows-latest
              cxx: /mingw64/bin/g++
              shell: msys2 {0}
    defaults:
      run:
        shell: ${{ matrix.shell }}
    steps:
      - if: contains(matrix.os, 'windows')
        uses: actions/cache@v2
        with:
          path: C:\Users\runneradmin\AppData\Local\Temp\chocolatey
          key: ${{ runner.os }}-chocolatey-${{ matrix.os }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-chocolatey-${{ matrix.os }}-
            ${{ runner.os }}-chocolatey-
      - if: contains(matrix.os, 'windows')
        name: prepare windows env
        run: | 
          choco install cmake ninja msys2 --no-progress
          call "C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise\Common7\Tools\VsDevCmd.bat" -arch=amd64 -host_arch=amd64
          call refreshenv
          echo ::set-env name=PATH::%PATH%
          echo ::set-env name=MSYS2_PATH_TYPE::inherit
        shell: cmd
      - if: contains(matrix.os, 'windows')
        name: windows dependencies
        run: pacman --noconfirm -S flex bison mingw-w64-x86_64-gcc mingw64/mingw-w64-x86_64-llvm mingw64/mingw-w64-x86_64-libsndfile mingw64/mingw-w64-x86_64-opus"
      - if: contains(matrix.os, 'macos')
        run: |
          HOMEBREW_NO_AUTO_UPDATE=1 brew install flex bison libsndfile llvm@9 ninja
      - if: contains(matrix.os, 'ubuntu')
        run: |
          brew install llvm@9
          sudo apt-get install libalsa-ocaml-dev libfl-dev libbison-dev libz-dev libsndfile-dev libopus-dev gcc-9 ninja-build
      - uses: actions/checkout@v2
      - name: configure
        run:
          cmake . -Bbuild -GNinja -DCMAKE_BUILD_CONFIG=${{ matrix.config }} -DCMAKE_CXX_COMPILER=${{ matrix.cxx }} 
      - name: build
        run: cmake --build build -j
      - name: test
        run: cd build && ctest
